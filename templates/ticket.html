<!DOCTYPE html>
<html>
<head>
    <title>Ticket {{ ticket[0] }}</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }
        #header {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1; 
        }
        #sidebar {
            position: fixed;
            width: 200px;
            height: 100%;
            background-color: #f8f9fa;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            top: 0; 
            z-index: 2; 
            resize: horizontal;
            overflow: auto;
        }
        #sidebar .tickets {
            display: flex;
            flex-direction: column;
        }
        #sidebar .ticket {
            border: 1px solid #000;
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
            box-sizing: border-box;
        }
        #chat {
            margin-left: 210px;
            margin-top: 120px; 
            padding-bottom: 60px; 
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .message {
            border: 1px solid #000;
            border-radius: 10px;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 5px;
            padding-bottom: 14px;
            margin: 10px;
            display: inline-block;
            width: 20%;
            min-width: 300px; 
            position: relative; 
        }
        .message.you {
            background-color: lightblue;
        }
        .message .timestamp {
            position: absolute;
            bottom: -10px; 
            right: 5px; 
            color: #aaa;
            font-size: 0.8em; 
        }
        #message-form {
            position: fixed;
            bottom: 0;
            width: calc(100% - 210px); 
            background-color: #f8f9fa;
            padding: 10px;
            box-sizing: border-box;
            left: 210px; 
        }
        .ticket.closed {
            background-color: rgb(238, 96, 96);
        }

        #resize-handle {
            position: absolute;
            right: 0;
            width: 10px;
            height: 100%;
            cursor: col-resize;
        }
        .message img {
            max-width: 100%;
            height: auto;
        }
@media (max-aspect-ratio: 16/9) {
    #sidebar {
        position: fixed;
        width: 100%;
        height: 100%;
        left: -100%;
        transition: left 0.3s;
    }
    #sidebar.open {
        left: 0;
    }
    #chat {
        margin-left: 0;
        margin-top: 0;
    }
    #message-form {
        width: 120%;
        left: 0;
    }
    #sidebar-toggle {
        display: block;
    }
    
    .message {
        width: 90%;
        min-width: 0;
        font-size: 2em;
    }
}
    #sidebar-toggle {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 3; /* Установите z-index выше, чем у остальных элементов сайдбара */
    }
    #sidebar-close {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 3; /* Установите z-index выше, чем у остальных элементов сайдбара */
    }
    </style>
</head>
<body>
    <audio id="messageSound" src="/static/message_sound.mp3" preload="auto"></audio>
    <div id="header">
        <button id="sidebar-toggle">☰</button>
        <h1>Name: {{ ticket[3] }}, Username: {{ ticket[2] }}, Theme {{ ticket[6] }}</h1>
        <button id="toggle-ticket" data-status="{{ ticket[4] }}">Toggle Ticket</button>
    </div>
    <div id="sidebar">
        <button id="sidebar-close">X</button>
        <h2>Tickets</h2>
        <div class="tickets">
            {% for ticket in tickets|sort(attribute='status') %}
            <div class="ticket {% if ticket[4] == 'closed' %}closed{% endif %}">
                <a href="{{ url_for('ticket', id=ticket[0]) }}">
                    <p>Username: {{ ticket[2] }}</p>
                    <p>Name: {{ ticket[3] }}</p>
                    <p>Theme: {{ ticket[6] }}</p>
                    <p>Status: {{ ticket[4] }}</p>
                </a>
            </div>
            {% endfor %}
        </div>
        <div id="resize-handle"></div>
    </div>
    <div id="chat">
    </div>
    <form id="message-form" method="POST">
        <input type="hidden" name="id" value="{{ ticket[0] }}">
        <div style="display: flex; justify-content: space-between;">
            <div style="width: 20%;">
                <input type="text" name="nickname" required placeholder="Enter your nickname" style="width: 100%;">
            </div>
            <div style="width: 70%;">
                <input type="text" name="message" required placeholder="Enter your message" style="width: 100%;">
            </div>
            <div style="width: 9%;">
                <input type="submit" value="Send" style="width: 100%;" {% if ticket[4] == 'closed' %}disabled{% endif %}>
            </div>
        </div>
    </form>
</body>
</html>
<script>
    var lastMessageTimestamp = localStorage.getItem('lastMessageTimestamp') || 0; // Get the last timestamp from localStorage

    async function updateChat(scrollDown = false) {
        var id = document.querySelector('#message-form input[name="id"]').value;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', encodeURIComponent(id) + '/chat', true);
        xhr.onload = async function() {
            if (this.status == 200) {
                var chat = JSON.parse(this.responseText);
                var chatDiv = document.getElementById('chat');
                var oldChatLength = chatDiv.children.length; 
    
                var messagePromises = chat.map(async (message, i) => {
                    if (oldChatLength === 0 || message[1] > lastMessageTimestamp) { 
                        var messageDiv = document.createElement('div');
                        messageDiv.className = 'message';
                        lastMessageTimestamp = message[1];
                        localStorage.setItem('lastMessageTimestamp', lastMessageTimestamp); 
                        
                        if (message[2] === 'Вы') {
                            messageDiv.classList.add('you');
                        }
                        var messageContent = message[0];
                        if (messageContent.startsWith('file:')) {
                            var parts = messageContent.split(':');
                            var fileId = parts[1];
                            var format = parts[2];
                        
                            try {
                                var response = await fetch('/images/' + fileId);
                                var blob = await response.blob();
                                var reader = new FileReader();

                                var readPromise = new Promise((resolve, reject) => {
                                    reader.onloadend = function() {
                                        var base64data = reader.result;                
                                        var img = document.createElement('img');
                                        img.src = base64data;

                                        var imageDiv = document.createElement('div'); 
                                        imageDiv.className = 'message';

                                        var sender = document.createElement('p');
                                        sender.innerHTML = '<strong>' + message[2] + '</strong>'; 

                                        var timestamp = document.createElement('p');
                                        timestamp.className = 'timestamp';
                                        timestamp.textContent = new Date(message[1] * 1000).toLocaleString(); 

                                        imageDiv.appendChild(sender);
                                        imageDiv.appendChild(timestamp);
                                        imageDiv.appendChild(img);

                                        resolve(imageDiv);
                                    }
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                });

                                return readPromise;
                            } catch (error) {
                                console.error('Error:', error);
                            }
                        } else {
                            messageDiv.innerHTML = '<p><strong>' + message[2] + '</strong></p>' +
                                                '<p>' + messageContent + '</p>' +
                                                '<p class="timestamp">' + new Date(message[1] * 1000).toLocaleString() + '</p>';
                            return messageDiv;
                        }
                        lastMessageTimestamp = message[1]; 
                    }
                });
    
                var messageDivs = await Promise.all(messagePromises);

                messageDivs.forEach(messageDiv => {
                    if (messageDiv) {
                        chatDiv.appendChild(messageDiv);
                    }
                });

                if (chat.length > oldChatLength) {
                    var messageSound = document.getElementById('messageSound');
                    messageSound.play(); 
                }
                
                if (scrollDown) {
                    window.scrollTo({
                        top: document.documentElement.scrollHeight,
                        behavior: 'smooth'
                    });
                }

                if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 500) {
                    window.scrollTo({
                        top: document.documentElement.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }
        };
        xhr.send();
    }
    
    document.getElementById('message-form').addEventListener('submit', function(event) {
        event.preventDefault();
        var nicknameInput = document.querySelector('#message-form input[name="nickname"]');
        var nickname = nicknameInput.value;
        if (nicknameInput.style.display !== 'none') {
            setCookie('nickname', nickname, 365); 
        }
        event.preventDefault();
        var nickname = document.querySelector('#message-form input[name="nickname"]').value;
        setCookie('nickname', nickname, 365);

        event.preventDefault();
        var nickname = document.querySelector('#message-form input[name="nickname"]').value;
        var message = document.querySelector('#message-form input[name="message"]').value;
        var id = document.querySelector('#message-form input[name="id"]').value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'send_message', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
            if (this.status == 200 && JSON.parse(this.responseText).status == 'success') {
                document.querySelector('#message-form input[name="message"]').value = '';
                updateChat();
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }
        };
        xhr.send('nickname=' + encodeURIComponent(nickname) + '&message=' + encodeURIComponent(message) + '&id=' + encodeURIComponent(id));
        document.querySelector('#message-form input[name="message"]').focus();
    });
    
    document.getElementById('toggle-ticket').addEventListener('click', function() {
        var id = document.querySelector('#message-form input[name="id"]').value;
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/toggle_ticket', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
            if (this.status == 200) {
                var status = JSON.parse(this.responseText).status;
                var button = document.getElementById('toggle-ticket');
                button.textContent = status === 'open' ? 'Close Ticket' : 'Open Ticket';
                var inputs = document.querySelectorAll('#message-form input');
                for (var i = 0; i < inputs.length; i++) {
                    inputs[i].disabled = status === 'closed';
                }
            }
        };
        xhr.send('id=' + encodeURIComponent(id));
    });

    function updateTickets() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/tickets_data', true);
        xhr.onload = function() {
            if (this.status == 200) {
                var tickets = JSON.parse(this.responseText);
                var ticketsDiv = document.querySelector('#sidebar .tickets');
                var oldTicketsLength = ticketsDiv.children.length; 
                ticketsDiv.innerHTML = '';
                for (var i = 0; i < tickets.length; i++) {
                    var ticketDiv = document.createElement('div');
                    ticketDiv.className = 'ticket';
                    if (tickets[i][4] === 'closed') {
                        ticketDiv.classList.add('closed');
                    }
                    ticketDiv.innerHTML = '<a href="' + tickets[i][0] + '">' +
                                        '<p>Username: ' + tickets[i][2] + '</p>' +
                                        '<p>Name: ' + tickets[i][3] + '</p>' +
                                        '<p>Theme: ' + tickets[i][6] + '</p>' +
                                        '<p>Status: ' + tickets[i][4] + '</p>' +
                                        '</a>';
                    ticketsDiv.appendChild(ticketDiv);
                }
                if (tickets.length > oldTicketsLength) { 
                    var ticketSound = document.getElementById('messageSound');
                    ticketSound.play(); 
                }
            }
        };
        xhr.send();
    }


    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }

    var sidebar = document.getElementById('sidebar');
    var resizeHandle = document.getElementById('resize-handle');

    resizeHandle.addEventListener('mousedown', function(e) {
        e.preventDefault();
        sidebar.style.userSelect = 'none';
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
    });


    function stopResize() {
        sidebar.style.userSelect = '';
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
    }

    document.getElementById('sidebar-toggle').addEventListener('click', function() {
        var sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        } else {
            sidebar.classList.add('open');
        }
    });

    document.getElementById('sidebar-close').addEventListener('click', function() {
        var sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('open');
    });

    window.onload = async function() {
        var nickname = getCookie('nickname');
        var nicknameInput = document.querySelector('#message-form input[name="nickname"]');
        var messageInput = document.querySelector('#message-form input[name="message"]');
        var buttonMessage = document.querySelector('#message-form input[type="submit"]');
        if (nickname) {
            nicknameInput.value = nickname;
            nicknameInput.style.display = 'none'; 
            messageInput.style.marginLeft = '-100px'; 
            buttonMessage.style.marginLeft = '-100px';
        }
        if (nickname) {
            document.querySelector('#message-form input[name="nickname"]').value = nickname;
        }
        var button = document.getElementById('toggle-ticket');
        var status = button.getAttribute('data-status');
        button.textContent = status === 'open' ? 'Close Ticket' : 'Open Ticket';
        await updateChat(true);
        window.scrollTo(0, document.body.scrollHeight);
        setInterval(updateChat, 2000); 
        setInterval(updateTickets, 5000);
    };
</script>